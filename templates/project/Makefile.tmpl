# Project name
PROJECT_NAME = {{if .ProjectName}}{{.ProjectName}}{{else}}my-microservice{{end}}

# Go parameters
GOCMD = go
GOBUILD = $(GOCMD) build
GOCLEAN = $(GOCMD) clean
GOTEST = $(GOCMD) test
GOGET = $(GOCMD) get
GOMOD = $(GOCMD) mod
BINARY_NAME = $(PROJECT_NAME)

# Protobuf compiler
PROTOC = protoc
PROTO_PATH = api/proto
PROTO_GO_OUT = pkg/pb

# Docker parameters
DOCKER = docker
DOCKER_COMPOSE = docker-compose
DOCKER_IMAGE = $(PROJECT_NAME)

# Database parameters
{{if .WithDB}}
DB_NAME = $(PROJECT_NAME)
DB_USER = user
DB_PASSWORD = password
DB_PORT = 5432
{{end}}

.PHONY: all build clean test run docker-build docker-run proto

all: test build

build:
	$(GOBUILD) -o $(BINARY_NAME) ./cmd/server

clean:
	$(GOCLEAN)
	rm -f $(BINARY_NAME)

test:
	$(GOTEST) -v ./...

run: build
	./$(BINARY_NAME)

docker-build:
	$(DOCKER) build -t $(DOCKER_IMAGE) .

docker-run: docker-build
	$(DOCKER) run -p 50051:50051 $(DOCKER_IMAGE)

docker-compose-up:
	$(DOCKER_COMPOSE) up -d --build

docker-compose-down:
	$(DOCKER_COMPOSE) down

proto:
	@if [ ! -d "$(PROTO_GO_OUT)" ]; then mkdir -p $(PROTO_GO_OUT); fi
	$(PROTOC) --go_out=$(PROTO_GO_OUT) --go-grpc_out=$(PROTO_GO_OUT) $(PROTO_PATH)/*.proto

{{if .WithDB}}
db-migrate:
	@echo "Running database migrations..."
	# Add your migration command here

db-seed:
	@echo "Seeding database..."
	# Add your seed command here
{{end}}

lint:
	golangci-lint run

tidy:
	$(GOMOD) tidy

vendor:
	$(GOMOD) vendor

help:
	@echo "Available targets:"
	@echo "  all          - Run tests and build"
	@echo "  build        - Build the binary"
	@echo "  clean        - Remove built binary"
	@echo "  test         - Run tests"
	@echo "  run          - Build and run the binary"
	@echo "  docker-build - Build Docker image"
	@echo "  docker-run   - Run Docker container"
	@echo "  docker-compose-up   - Start all services with Docker Compose"
	@echo "  docker-compose-down - Stop all services with Docker Compose"
	@echo "  proto        - Generate protobuf code"
	{{if .WithDB}}
	@echo "  db-migrate   - Run database migrations"
	@echo "  db-seed      - Seed database with initial data"
	{{end}}
	@echo "  lint         - Run linter"
	@echo "  tidy         - Tidy go.mod"
	@echo "  vendor       - Create vendor directory"